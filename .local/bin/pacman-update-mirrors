#!/bin/bash

set -eo pipefail

while getopts 'c:dt:' opt; do
    case "$opt" in
    \?) exit 1 ;;
    c) country="$OPTARG" ;;
    d) showdiff=1 ;;
    t) target="$OPTARG" ;;
    esac
done
shift $((OPTIND-1))

tmp="$(mktemp --suffix .mirrorlist)"
target="${target:-/etc/pacman.d/mirrorlist}"

if [ -z "$country" ]; then
    shopt -s lastpipe
    curl -Ss https://api.country.is | jq -r .country | read -r country
    shopt -u lastpipe
fi

# The official mirror status page considers mirrors out of sync after 3 days
reflector --verbose --age 12 --protocol https --sort rate --country "$country" \
>"$tmp"

[ -f "$tmp" ] || { >&2 echo "error: mirrors not fetched"; exit 1; }

if (( showdiff )); then
    diff --unified --minimal --new-file --color=auto "$target" "$tmp" \
    || [ $? -eq 1 ] # 1 means files are different, not an error in this case
fi

sudo cp "$target" "$target.old" \
&& sudo tee "$target" <"$tmp" >/dev/null
